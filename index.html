<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Grand City Survivor: Ultimate</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; cursor: crosshair; }
        
        /* UI Overlay */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
        }
        
        /* Stats Panel */
        #stats {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 8px;
            color: white; border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #stats h2 { margin: 0 0 10px 0; font-size: 18px; text-transform: uppercase; letter-spacing: 2px; }
        .stat-row { font-size: 14px; margin-bottom: 5px; color: #ccc; }
        
        /* Hotbar */
        #hotbar-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px;
        }
        .slot {
            width: 60px; height: 60px; background: rgba(30, 30, 30, 0.9);
            border: 2px solid #555; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; transition: 0.2s; position: relative;
        }
        .slot.active { border-color: #f1c40f; transform: translateY(-10px); background: #333; box-shadow: 0 0 15px #f1c40f; }
        .slot-num { position: absolute; top: 2px; left: 5px; font-size: 10px; color: #888; }
        .slot-icon { font-size: 20px; font-weight: bold; }
        .slot-name { font-size: 9px; margin-top: 5px; text-transform: uppercase; }

        /* Health & Ammo */
        #bars {
            position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%);
            width: 400px; display: flex; flex-direction: column; gap: 5px;
        }
        .bar-bg { width: 100%; height: 15px; background: #333; border: 2px solid #fff; border-radius: 4px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: #e74c3c; transition: width 0.1s; }
        #ammo-fill { height: 100%; width: 100%; background: #f1c40f; transition: width 0.1s; }
        
        /* Meldinger */
        #message {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: white; text-shadow: 2px 2px 0 #000; display: none;
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="stats">
            <h2>City Controls</h2>
            <div class="stat-row"><b>WASD</b> - Bevegelse / Gass</div>
            <div class="stat-row"><b>MUS</b> - Sikt og Snu deg</div>
            <div class="stat-row"><b>KLIKK</b> - Skyt</div>
            <div class="stat-row"><b>E</b> - GÃ¥ inn/ut av bil</div>
            <div class="stat-row"><b>T</b> - Plukk opp</div>
            <div class="stat-row"><b>M</b> - Bruk Medkit</div>
            <div class="stat-row"><b>1-6</b> - Bytt VÃ¥pen</div>
        </div>

        <div id="message"></div>

        <div id="bars">
            <div class="bar-bg"><div id="hp-fill"></div></div>
            <div class="bar-bg" style="border-color: #f1c40f;"><div id="ammo-fill"></div></div>
        </div>

        <div id="hotbar-container">
            </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
// --- MOTOR OPPSETT ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- SPILL INNSTILLINGER ---
const WORLD_SIZE = 4000;
const BLOCK_SIZE = 400; // StÃ¸rrelse pÃ¥ et by-kvartal
const ROAD_WIDTH = 120;

const keys = {};
const mouse = { x: 0, y: 0 };
let activeSlot = 0;
let cameraShake = 0;

// Teksturer (Enkle mÃ¸nstre)
const patterns = {};
function createPatterns() {
    const mkPat = (c1, c2, size) => {
        const c = document.createElement('canvas'); c.width=size; c.height=size;
        const x = c.getContext('2d');
        x.fillStyle=c1; x.fillRect(0,0,size,size);
        x.fillStyle=c2; x.fillRect(0,0,size/2,size/2); x.fillRect(size/2,size/2,size/2,size/2);
        return ctx.createPattern(c, 'repeat');
    };
    patterns.grass = mkPat('#2ecc71', '#27ae60', 64);
    patterns.road = mkPat('#444', '#555', 32);
    patterns.sidewalk = mkPat('#95a5a6', '#7f8c8d', 16);
}
createPatterns();

// --- OBJEKTER ---
const player = { 
    x: 200, y: 200, angle: 0, 
    hp: 100, maxHp: 100, speed: 4, baseSpeed: 4,
    inVehicle: false, inventory: Array(6).fill(null)
};

const car = { 
    x: 400, y: 400, w: 70, h: 130, angle: 0, 
    speed: 0, maxSpeed: 16, accel: 0.3, friction: 0.96, turnSpeed: 0.06 
};

// VÃ¥pen Database
const weaponDB = {
    'Pistol': { dmg: 20, fireRate: 20, speed: 18, spread: 0.05, auto: false, color: '#f1c40f', ammo: Infinity },
    'AK-47':  { dmg: 12, fireRate: 5,  speed: 22, spread: 0.15, auto: true,  color: '#e67e22', ammo: 100 },
    'Hagle':  { dmg: 10, fireRate: 45, speed: 15, spread: 0.40, count: 6, auto: false, color: '#e74c3c', ammo: 20 },
    'Sniper': { dmg: 90, fireRate: 60, speed: 35, spread: 0.01, auto: false, color: '#8e44ad', ammo: 10 }
};

// Verden Data
const buildings = [];
const enemies = [];
const items = [];
const projectiles = [];
const particles = [];

// --- GENERER BY ---
function generateCity() {
    // Lag rutenett
    for (let x = 0; x < WORLD_SIZE; x += BLOCK_SIZE) {
        for (let y = 0; y < WORLD_SIZE; y += BLOCK_SIZE) {
            // Sjanse for Ã¥ lage et hus i midten av kvartalet
            if (Math.random() > 0.1) {
                const bW = BLOCK_SIZE - ROAD_WIDTH - 40;
                const bH = BLOCK_SIZE - ROAD_WIDTH - 40;
                const bX = x + ROAD_WIDTH/2 + 20;
                const bY = y + ROAD_WIDTH/2 + 20;
                // Type bygning: 0 = GrÃ¥ skyskraper, 1 = Brun murstein, 2 = Park (ingen bygning)
                const type = Math.random() > 0.2 ? (Math.random() > 0.5 ? 'gray' : 'brick') : 'park';
                
                if (type !== 'park') {
                    buildings.push({ 
                        x: bX, y: bY, w: bW, h: bH, 
                        color: type === 'gray' ? '#7f8c8d' : '#8d6e63',
                        roofColor: type === 'gray' ? '#95a5a6' : '#a1887f',
                        height: 40 // "3D" hÃ¸yde effekt
                    });
                } else {
                    // Spawn items i parker
                    if (Math.random() > 0.5) spawnItem(bX + bW/2, bY + bH/2);
                }
            }
        }
    }
}

function spawnItem(x, y) {
    const types = ['Medkit', 'Ammo', 'Boost', 'AK-47', 'Hagle', 'Sniper'];
    const type = types[Math.floor(Math.random() * types.length)];
    let color = 'white';
    if(type === 'Medkit') color = '#2ecc71';
    if(type === 'Ammo') color = '#f39c12';
    if(type === 'Boost') color = '#3498db';
    
    items.push({ x, y, type, color });
}

function spawnEnemies(count) {
    for(let i=0; i<count; i++) {
        enemies.push({
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            hp: 100, maxHp: 100,
            speed: 1 + Math.random() * 2,
            angle: 0
        });
    }
}

// Start
generateCity();
spawnEnemies(50);
spawnItem(player.x + 100, player.y); // Start gave
player.inventory[0] = 'Pistol';

// --- INPUT HÃ…NDTERING ---
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key >= '1' && e.key <= '6') { activeSlot = parseInt(e.key)-1; updateUI(); }
    if(e.key.toLowerCase() === 'm') useItem('Medkit');
    if(e.key.toLowerCase() === 'e') toggleVehicle();
    if(e.key.toLowerCase() === 't') pickUpItem();
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mousedown', () => keys['mouse'] = true);
window.addEventListener('mouseup', () => keys['mouse'] = false);

// --- LOGIKK ---
function toggleVehicle() {
    const dist = Math.hypot(player.x - car.x, player.y - car.y);
    if(player.inVehicle) {
        player.inVehicle = false;
        player.x = car.x + Math.cos(car.angle + Math.PI/2)*50;
        player.y = car.y + Math.sin(car.angle + Math.PI/2)*50;
    } else if (dist < 80) {
        player.inVehicle = true;
    }
}

function useItem(type) {
    if(type === 'Medkit' && player.hp < 100) {
        // Finn medkit i inventory
        const idx = player.inventory.indexOf('Medkit');
        if(idx !== -1) {
            player.hp = Math.min(player.hp + 50, 100);
            player.inventory[idx] = null;
            showMessage("+50 HP");
            updateUI();
        }
    }
}

function pickUpItem() {
    if(player.inVehicle) return;
    items.forEach((it, idx) => {
        if(Math.hypot(player.x - it.x, player.y - it.y) < 50) {
            if (it.type === 'Ammo') {
                showMessage("Ammo Refill!");
                // Fyller bare "magisk" opp nÃ¥ for enkelhet
            } else if (it.type === 'Boost') {
                player.speed = 8;
                setTimeout(() => player.speed = player.baseSpeed, 5000);
                showMessage("Speed Boost!");
                items.splice(idx, 1);
            } else {
                // VÃ¥pen eller Medkit
                for(let i=0; i<6; i++) {
                    if(!player.inventory[i]) {
                        player.inventory[i] = it.type;
                        items.splice(idx, 1);
                        updateUI();
                        break;
                    }
                }
            }
        }
    });
}

function showMessage(txt) {
    const msg = document.getElementById('message');
    msg.innerText = txt; msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 2000);
}

// Skytetimer
let fireCooldown = 0;

function update() {
    if(player.hp <= 0) {
        ctx.fillStyle = "rgba(100,0,0,0.5)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "white"; ctx.font = "50px Arial";
        ctx.fillText("WASTED", canvas.width/2 - 100, canvas.height/2);
        return;
    }

    if(cameraShake > 0) cameraShake *= 0.9;

    // --- SPILLER LOGIKK ---
    if (!player.inVehicle) {
        // Mus sikting (Rotasjon)
        player.angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);

        // Bevegelse (WASD)
        let dx = 0, dy = 0;
        if(keys['w']) dy -= 1;
        if(keys['s']) dy += 1;
        if(keys['a']) dx -= 1;
        if(keys['d']) dx += 1;

        // Normaliser diagonal fart
        if(dx!==0 || dy!==0) {
            const length = Math.hypot(dx, dy);
            dx /= length; dy /= length;
            player.x += dx * player.speed;
            player.y += dy * player.speed;
        }
        
        // Skyting
        if(fireCooldown > 0) fireCooldown--;
        const currentWepName = player.inventory[activeSlot];
        const weapon = weaponDB[currentWepName];
        
        if(keys['mouse'] && weapon && fireCooldown <= 0) {
            fireCooldown = weapon.fireRate;
            if(!weapon.auto) keys['mouse'] = false; // MÃ¥ klikke igjen for semi-auto
            
            cameraShake = 5;
            const count = weapon.count || 1;
            for(let i=0; i<count; i++) {
                const spread = (Math.random()-0.5) * weapon.spread;
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(player.angle + spread) * weapon.speed,
                    vy: Math.sin(player.angle + spread) * weapon.speed,
                    dmg: weapon.dmg,
                    life: 50, color: 'yellow'
                });
            }
        }
    } 
    // --- BIL LOGIKK ---
    else {
        if(keys['w']) car.speed += car.accel;
        if(keys['s']) car.speed -= car.accel; // Brems/Revers
        
        car.speed *= car.friction;
        
        // Kan bare svinge hvis bilen beveger seg
        if(Math.abs(car.speed) > 0.5) {
            const dir = car.speed > 0 ? 1 : -1; // Svinger motsatt nÃ¥r man rygger
            if(keys['a']) car.angle -= car.turnSpeed * dir;
            if(keys['d']) car.angle += car.turnSpeed * dir;
        }

        car.x += Math.cos(car.angle) * car.speed;
        car.y += Math.sin(car.angle) * car.speed;
        player.x = car.x; player.y = car.y; // Spiller fÃ¸lger bil
    }

    // --- FIENDER LOGIKK ---
    enemies.forEach(en => {
        const dist = Math.hypot(player.x - en.x, player.y - en.y);
        
        // Sjekk om spiller er i hus (Safe zone)
        let safe = false;
        if(!player.inVehicle) {
            buildings.forEach(b => {
                if(player.x > b.x && player.x < b.x+b.w && player.y > b.y && player.y < b.y+b.h) safe = true;
            });
        }

        if(dist < 600 && !safe) {
            en.angle = Math.atan2(player.y - en.y, player.x - en.x);
            en.x += Math.cos(en.angle) * en.speed;
            en.y += Math.sin(en.angle) * en.speed;
        }

        if(dist < 30 && !player.inVehicle && !safe) {
            player.hp -= 0.5;
            updateUI();
        }
    });

    // Kollisjon: Prosjektiler vs Fiender
    for(let i=projectiles.length-1; i>=0; i--) {
        const p = projectiles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        
        let hit = false;
        // Sjekk treff pÃ¥ fiender
        enemies.forEach((en, eIdx) => {
            if(!hit && Math.hypot(p.x - en.x, p.y - en.y) < 25) {
                en.hp -= p.dmg;
                hit = true;
                // Blod effekt
                for(let k=0; k<5; k++) particles.push({x:en.x, y:en.y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, life:20, color:'darkred'});
                
                if(en.hp <= 0) {
                    enemies.splice(eIdx, 1);
                    // Drop loot sjanse
                    if(Math.random()>0.7) spawnItem(en.x, en.y);
                }
            }
        });
        
        // Sjekk treff pÃ¥ husvegger
        if(!hit) {
            buildings.forEach(b => {
                if(p.x > b.x && p.x < b.x+b.w && p.y > b.y && p.y < b.y+b.h) hit = true;
            });
        }

        if(hit || p.life <= 0) projectiles.splice(i, 1);
    }

    // Partikler
    for(let i=particles.length-1; i>=0; i--) {
        const p = particles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    }
}

function draw() {
    // Kamera posisjon
    let camX = -player.x + canvas.width/2 + (Math.random()-0.5)*cameraShake;
    let camY = -player.y + canvas.height/2 + (Math.random()-0.5)*cameraShake;

    ctx.fillStyle = "#222";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(camX, camY);

    // 1. Tegn bakken (Gress overalt fÃ¸rst)
    ctx.fillStyle = patterns.grass;
    // Optimalisering: Tegn bare rundt spiller
    ctx.fillRect(player.x - 1500, player.y - 1500, 3000, 3000);

    // 2. Tegn veier (Grid)
    ctx.fillStyle = patterns.road;
    for(let x = 0; x < WORLD_SIZE; x += BLOCK_SIZE) {
        ctx.fillRect(x, 0, ROAD_WIDTH, WORLD_SIZE); // Vertikal
        ctx.fillRect(0, x, WORLD_SIZE, ROAD_WIDTH); // Horisontal
        
        // Veistriper
        ctx.fillStyle = "#ecf0f1";
        for(let k=0; k<WORLD_SIZE; k+=80) {
            ctx.fillRect(x + ROAD_WIDTH/2 - 2, k, 4, 40);
            ctx.fillRect(k, x + ROAD_WIDTH/2 - 2, 40, 4);
        }
        ctx.fillStyle = patterns.road;
    }

    // 3. Items
    items.forEach(it => {
        // GlÃ¸dende effekt
        ctx.shadowBlur = 15; ctx.shadowColor = it.color;
        ctx.fillStyle = it.color; 
        ctx.fillRect(it.x-10, it.y-10, 20, 20);
        ctx.shadowBlur = 0;
        ctx.fillStyle = "white"; ctx.font="10px Arial"; ctx.fillText(it.type, it.x-15, it.y-15);
    });

    // 4. Fiender
    enemies.forEach(en => {
        ctx.save();
        ctx.translate(en.x, en.y);
        ctx.rotate(en.angle);
        ctx.fillStyle = "#c0392b";
        ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(10, 5, 5, 0, Math.PI*2); ctx.fill(); // Ã˜ye
        ctx.beginPath(); ctx.arc(10, -5, 5, 0, Math.PI*2); ctx.fill(); // Ã˜ye
        // Helsebar over fiende
        ctx.fillStyle = "red"; ctx.fillRect(-20, -35, 40, 5);
        ctx.fillStyle = "#2ecc71"; ctx.fillRect(-20, -35, 40 * (en.hp/en.maxHp), 5);
        ctx.restore();
    });

    // 5. Spiller
    if(!player.inVehicle) {
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.rotate(player.angle);
        // Kropp
        ctx.fillStyle = "#3498db"; 
        ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
        // Skuldre
        ctx.fillStyle = "#2980b9";
        ctx.beginPath(); ctx.arc(0, 15, 10, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(0, -15, 10, 0, Math.PI*2); ctx.fill();
        // VÃ¥pen
        const wep = player.inventory[activeSlot];
        if(wep && weaponDB[wep]) {
            ctx.fillStyle = weaponDB[wep].color;
            ctx.fillRect(10, 8, 30, 6); // HÃ¸yre hÃ¥nd vÃ¥pen
        }
        ctx.restore();
    }

    // 6. Bil
    ctx.save();
    ctx.translate(car.x, car.y);
    ctx.rotate(car.angle);
    // Skygge
    ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 20;
    // Karosseri
    ctx.fillStyle = "#2c3e50"; ctx.fillRect(-car.w/2, -car.h/2, car.w, car.h);
    // Frontrute
    ctx.fillStyle = "#3498db"; ctx.fillRect(-car.w/2+5, -car.h/2+10, car.w-10, 25);
    // Bakrute
    ctx.fillStyle = "#34495e"; ctx.fillRect(-car.w/2+5, car.h/2-25, car.w-10, 15);
    // Lys
    ctx.shadowBlur = 10; ctx.shadowColor = "yellow";
    ctx.fillStyle = "yellow"; 
    ctx.fillRect(car.w/2-10, -car.h/2, 5, 5); ctx.fillRect(-car.w/2+5, -car.h/2, 5, 5);
    // Bremselys
    ctx.shadowColor = "red";
    ctx.fillStyle = "red";
    ctx.fillRect(car.w/2-10, car.h/2-5, 5, 5); ctx.fillRect(-car.w/2+5, car.h/2-5, 5, 5);
    ctx.shadowBlur = 0;
    ctx.restore();

    // 7. Partikler
    particles.forEach(p => {
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life/20;
        ctx.fillRect(p.x, p.y, 4, 4);
        ctx.globalAlpha = 1;
    });

    // 8. Prosjektiler
    projectiles.forEach(p => {
        ctx.fillStyle = "#f1c40f"; 
        ctx.shadowBlur = 5; ctx.shadowColor = "orange";
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    // 9. Bygninger (Tegnes til slutt for 3D effekt og gjennomsiktighet)
    buildings.forEach(b => {
        const dist = Math.hypot(player.x - (b.x+b.w/2), player.y - (b.y+b.h/2));
        const inside = (player.x > b.x && player.x < b.x+b.w && player.y > b.y && player.y < b.y+b.h);
        
        ctx.globalAlpha = inside ? 0.2 : 1.0;
        
        // Vegger (Simulert 3D ved Ã¥ forskyve taket)
        // Men her tegner vi bare taket for top-down
        ctx.fillStyle = b.color; // Veggfarge (vises som kant)
        ctx.fillRect(b.x, b.y, b.w, b.h);
        
        ctx.fillStyle = b.roofColor; // Takfarge
        ctx.fillRect(b.x + 5, b.y + 5, b.w - 10, b.h - 10);
        
        // "3D" kant nede for Ã¥ gi dybde
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillRect(b.x, b.y + b.h, b.w, 10);

        ctx.globalAlpha = 1.0;
    });

    ctx.restore();

    requestAnimationFrame(() => {
        update();
        draw();
    });
}

function updateUI() {
    // Inventory
    const container = document.getElementById('hotbar-container');
    container.innerHTML = '';
    
    for(let i=0; i<6; i++) {
        const item = player.inventory[i];
        const div = document.createElement('div');
        div.className = `slot ${i===activeSlot ? 'active' : ''}`;
        
        let icon = "";
        if(item === 'Pistol') icon = "ðŸ”«";
        if(item === 'AK-47') icon = "ï”«";
        if(item === 'Hagle') icon = "ðŸ’¥";
        if(item === 'Sniper') icon = "ðŸ”­";
        if(item === 'Medkit') icon = "âž•";
        if(item === 'Ammo') icon = "ðŸ“¦";
        if(item === 'Boost') icon = "âš¡";

        div.innerHTML = `<div class="slot-num">${i+1}</div>
                         <div class="slot-icon">${icon}</div>
                         <div class="slot-name">${item || 'Tom'}</div>`;
        container.appendChild(div);
    }
    
    // HP og Ammo
    document.getElementById('hp-fill').style.width = player.hp + "%";
    
    const currentWep = player.inventory[activeSlot];
    const wepData = weaponDB[currentWep];
    if(wepData && wepData.ammo !== Infinity) {
        document.getElementById('ammo-fill').style.width = wepData.ammo + "%";
    } else {
        document.getElementById('ammo-fill').style.width = "100%";
    }
}

// Start GUI
updateUI();
draw();

// Tilpass vindu
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
</script>
</body>
</html>
