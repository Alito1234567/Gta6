<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>2D City Survivor Pro</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: white;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; font-size: 14px;
        }
        #hotbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 12px; border: 2px solid #444;
        }
        .slot {
            width: 60px; height: 60px; border: 2px solid #666; display: flex;
            flex-direction: column; justify-content: center; align-items: center; 
            color: white; position: relative; background: #333;
        }
        .slot.active { border-color: #00d4ff; background: #444; box-shadow: 0 0 10px #00d4ff; }
        .key-hint { position: absolute; top: 2px; left: 4px; font-size: 12px; color: #00d4ff; font-weight: bold; }
        .item-label { font-size: 10px; text-align: center; margin-top: 10px; }
        #hp-container {
            position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%);
            width: 320px; height: 20px; background: #222; border: 2px solid #fff;
        }
        #hp-bar { width: 100%; height: 100%; background: #ff4757; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="ui">
        <b>WASD</b>: Bevegelse | <b>E</b>: Inn/Ut Bil | <b>T</b>: Plukk opp<br>
        <b>1-9</b>: Velg Slot | <b>I</b>: Bruk/Skyte (Hold inne 2s for Medkit)
    </div>

    <div id="hp-container"><div id="hp-bar"></div></div>

    <div id="hotbar" id="slot-container">
        </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const worldSize = 5000;
const keys = {};
let activeSlot = 1;
let useTimer = 0;

// Spill-tilstand
const player = { 
    x: 2500, y: 2500, hp: 100, maxHp: 100, speed: 4, 
    inVehicle: false, inventory: Array(10).fill(null), angle: 0 
};

const car = { 
    x: 2700, y: 2700, w: 60, h: 110, angle: 0, speed: 0, 
    maxSpeed: 12, accel: 0.3, friction: 0.95, turnSpeed: 0.06 
};

const projectiles = [];
const enemies = Array.from({length: 20}, () => ({
    x: Math.random() * worldSize,
    y: Math.random() * worldSize,
    hp: 1, speed: 2, angle: 0
}));

const worldItems = [];
function spawnItems() {
    for(let i=0; i<15; i++) {
        worldItems.push({ x: Math.random()*worldSize, y: Math.random()*worldSize, type: 'Pistol', color: '#f1c40f' });
        worldItems.push({ x: Math.random()*worldSize, y: Math.random()*worldSize, type: 'Medkit', color: '#ff4757' });
    }
}
spawnItems();

const houses = Array.from({length: 15}, () => ({
    x: Math.random() * (worldSize - 300),
    y: Math.random() * (worldSize - 300),
    w: 200, h: 200
}));

// Input
window.addEventListener("keydown", e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key >= '1' && e.key <= '9') {
        activeSlot = parseInt(e.key);
        updateUI();
    }
});
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// Oppdater Hotbar UI
function updateUI() {
    const container = document.getElementById('hotbar');
    container.innerHTML = '';
    for (let i = 1; i <= 9; i++) {
        const item = player.inventory[i];
        const slot = document.createElement('div');
        slot.className = `slot ${i === activeSlot ? 'active' : ''}`;
        slot.innerHTML = `<span class="key-hint">${i}</span><span class="item-label">${item || ''}</span>`;
        container.appendChild(slot);
    }
}
updateUI();

function update() {
    // 1. Spiller og Bil Logikk
    if (!player.inVehicle) {
        if (keys['w']) player.y -= player.speed;
        if (keys['s']) player.y += player.speed;
        if (keys['a']) player.x -= player.speed;
        if (keys['d']) player.x += player.speed;
        
        // Snu spiller mot mus/bevegelse (forenklet)
        if (keys['w']||keys['a']||keys['s']||keys['d']) player.angle = Math.atan2(keys['s']-keys['w'], keys['d']-keys['a']);

        // Gå inn i bil
        if (keys['e']) {
            if (Math.hypot(player.x - car.x, player.y - car.y) < 80) {
                player.inVehicle = true;
                keys['e'] = false;
            }
        }
    } else {
        // Bilfysikk
        if (keys['w']) car.speed += car.accel;
        if (keys['s']) car.speed -= car.accel;
        car.speed *= car.friction;

        if (Math.abs(car.speed) > 0.5) {
            const direction = car.speed > 0 ? 1 : -1;
            if (keys['a']) car.angle -= car.turnSpeed * direction;
            if (keys['d']) car.angle += car.turnSpeed * direction;
        }

        car.x += Math.cos(car.angle) * car.speed;
        car.y += Math.sin(car.angle) * car.speed;
        player.x = car.x;
        player.y = car.y;

        // Gå ut av bil
        if (keys['e']) {
            player.inVehicle = false;
            player.x += Math.cos(car.angle + Math.PI/2) * 70;
            player.y += Math.sin(car.angle + Math.PI/2) * 70;
            keys['e'] = false;
        }
    }

    // 2. Bruk gjenstander (Pistol / Medkit)
    const currentItem = player.inventory[activeSlot];
    if (keys['i'] && !player.inVehicle) {
        if (currentItem === 'Pistol') {
            projectiles.push({
                x: player.x, y: player.y,
                vx: Math.cos(player.angle) * 12,
                vy: Math.sin(player.angle) * 12,
                life: 60
            });
            keys['i'] = false; // Semi-auto
        } else if (currentItem === 'Medkit') {
            useTimer++;
            if (useTimer > 100) { // ca 2 sek
                player.hp = 100;
                player.inventory[activeSlot] = null;
                useTimer = 0;
                updateUI();
            }
        }
    } else {
        useTimer = 0;
    }

    // 3. Plukk opp (T)
    if (keys['t']) {
        worldItems.forEach((item, idx) => {
            if (Math.hypot(player.x - item.x, player.y - item.y) < 50) {
                for(let i=1; i<=9; i++) {
                    if (!player.inventory[i]) {
                        player.inventory[i] = item.type;
                        worldItems.splice(idx, 1);
                        updateUI();
                        break;
                    }
                }
            }
        });
    }

    // 4. Fiender (Figurer som beveger seg)
    enemies.forEach((en, eIdx) => {
        const dist = Math.hypot(player.x - en.x, player.y - en.y);
        if (dist < 400) {
            en.angle = Math.atan2(player.y - en.y, player.x - en.x);
            en.x += Math.cos(en.angle) * en.speed;
            en.y += Math.sin(en.angle) * en.speed;
        }
        if (dist < 25 && !player.inVehicle) player.hp -= 0.3;
    });

    // 5. Prosjektil-kollisjon
    projectiles.forEach((p, pIdx) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        enemies.forEach((en, eIdx) => {
            if (Math.hypot(p.x - en.x, p.y - en.y) < 30) {
                enemies.splice(eIdx, 1);
                projectiles.splice(pIdx, 1);
            }
        });
        if(p.life <= 0) projectiles.splice(pIdx, 1);
    });

    if (player.hp <= 0) { alert("Game Over!"); location.reload(); }
    document.getElementById('hp-bar').style.width = player.hp + "%";
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-player.x + canvas.width/2, -player.y + canvas.height/2);

    // Bakgrunn (Gress og Veier)
    ctx.fillStyle = "#2ecc71"; ctx.fillRect(0,0, worldSize, worldSize);
    ctx.fillStyle = "#555";
    for(let i=0; i<worldSize; i+=1200) {
        ctx.fillRect(i, 0, 160, worldSize); // Vertikal vei
        ctx.fillRect(0, i, worldSize, 160); // Horisontal vei
    }

    // Hus
    houses.forEach(h => {
        ctx.fillStyle = "#8d6e63"; ctx.fillRect(h.x, h.y, h.w, h.h);
        ctx.strokeStyle = "#4e342e"; ctx.lineWidth = 5; ctx.strokeRect(h.x, h.y, h.w, h.h);
    });

    // Items
    worldItems.forEach(it => {
        ctx.fillStyle = it.color; ctx.fillRect(it.x-10, it.y-10, 20, 20);
        ctx.fillStyle = "white"; ctx.font = "10px Arial"; ctx.fillText(it.type, it.x-15, it.y-15);
    });

    // Fiender (Figurer)
    enemies.forEach(en => {
        ctx.fillStyle = "#c0392b";
        ctx.beginPath(); ctx.arc(en.x, en.y, 20, 0, Math.PI*2); ctx.fill(); // Kropp
        ctx.fillStyle = "#000"; ctx.fillRect(en.x + Math.cos(en.angle)*10, en.y + Math.sin(en.angle)*10, 5, 5); // Retning
    });

    // Bil (Detaljert)
    ctx.save();
    ctx.translate(car.x, car.y);
    ctx.rotate(car.angle);
    ctx.fillStyle = "#2980b9"; // Karosseri
    ctx.fillRect(-car.h/2, -car.w/2, car.h, car.w);
    ctx.fillStyle = "#333"; // Vinduer
    ctx.fillRect(-10, -car.w/2 + 5, 30, car.w - 10);
    ctx.fillStyle = "yellow"; // Lykter
    ctx.fillRect(car.h/2 - 5, -car.w/2 + 5, 8, 12);
    ctx.fillRect(car.h/2 - 5, car.w/2 - 17, 8, 12);
    ctx.restore();

    // Prosjektiler
    projectiles.forEach(p => {
        ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
    });

    // Spiller
    if (!player.inVehicle) {
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.rotate(player.angle);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#3498db"; ctx.fillRect(10, -5, 15, 10); // En liten "arm" som peker i retning
        ctx.restore();
    }

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
