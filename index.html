<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>2D Arena Survivor: Shop & Action</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; border: 4px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { background: #222; display: block; image-rendering: pixelated; }
        
        #hud {
            position: absolute; top: 10px; left: 10px; color: white;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; pointer-events: none;
        }

        #transition {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; display: none;
            align-items: center; justify-content: center; color: white; font-size: 30px;
            transition: opacity 0.5s; z-index: 10;
        }

        #death-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(150, 0, 0, 0.8); color: white; display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 20;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="hud">
            HP: <span id="hp">100</span> | <span id="loc">ARENA</span><br>
            VÅPEN: <span id="wpn">INGEN</span>
        </div>
        <div id="transition">GÅR INN...</div>
        <div id="death-screen">
            <h1>DU DØDE</h1>
            <button onclick="location.reload()">PRØV IGJEN</button>
        </div>
        <canvas id="game"></canvas>
    </div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 800; canvas.height = 600;

// Spill-tilstand
let state = "ARENA"; // Eller "SHOP"
let player = { x: 400, y: 300, size: 20, color: "#00ff00", hp: 100, hasGun: false, angle: 0, bullets: [] };
const keys = {};

// Kart-objekter (Bygninger, Dører, Våpen)
let arenaObjects = {
    walls: [{x: 100, y: 100, w: 200, h: 150, color: "#444"}],
    doors: [{x: 180, y: 250, w: 40, h: 10, target: "SHOP"}],
    guns: [{x: 600, y: 150, active: true}],
    enemies: [{x: 100, y: 500, hp: 3, active: true}, {x: 700, y: 500, hp: 3, active: true}]
};

let shopObjects = {
    walls: [{x: 0, y: 0, w: 800, h: 20}, {x: 0, y: 580, w: 800, h: 20}],
    shelves: [{x: 100, y: 100, w: 100, h: 40}, {x: 300, y: 100, w: 100, h: 40}],
    doors: [{x: 380, y: 550, w: 40, h: 30, target: "ARENA"}]
};

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function doTransition(target) {
    const trans = document.getElementById("transition");
    trans.style.display = "flex";
    setTimeout(() => trans.style.opacity = 1, 10);
    
    setTimeout(() => {
        state = target;
        document.getElementById("loc").innerText = state;
        if(state === "SHOP") { player.x = 400; player.y = 500; }
        else { player.x = 200; player.y = 280; }
        
        trans.style.opacity = 0;
        setTimeout(() => trans.style.display = "none", 500);
    }, 800);
}

function update() {
    if (player.hp <= 0) {
        document.getElementById("death-screen").style.display = "flex";
        return;
    }

    // Bevegelse
    if (keys['KeyW']) player.y -= 4;
    if (keys['KeyS']) player.y += 4;
    if (keys['KeyA']) player.x -= 4;
    if (keys['KeyD']) player.x += 4;

    // Sikte (Arrow keys)
    if (keys['ArrowLeft']) player.angle -= 0.1;
    if (keys['ArrowRight']) player.angle += 0.1;

    // Plukke opp (T)
    if (keys['KeyT'] && state === "ARENA") {
        // Sjekk dør
        arenaObjects.doors.forEach(d => {
            if (player.x > d.x && player.x < d.x + d.w && player.y > d.y && player.y < d.y + d.h) {
                doTransition("SHOP");
            }
        });
        // Sjekk våpen
        arenaObjects.guns.forEach(g => {
            if (g.active && Math.hypot(player.x - g.x, player.y - g.y) < 30) {
                g.active = false;
                player.hasGun = true;
                document.getElementById("wpn").innerText = "PISTOL";
            }
        });
    }
    
    if (keys['KeyT'] && state === "SHOP") {
        shopObjects.doors.forEach(d => {
            if (player.x > d.x && player.x < d.x + d.w && player.y > d.y && player.y < d.y + d.h) {
                doTransition("ARENA");
            }
        });
    }

    // Skyte (I)
    if (keys['KeyI'] && player.hasGun && keys['KeyI_ready'] !== false) {
        player.bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.angle) * 10, vy: Math.sin(player.angle) * 10 });
        keys['KeyI_ready'] = false;
        setTimeout(() => keys['KeyI_ready'] = true, 300);
    }

    // Bullet logikk
    player.bullets.forEach((b, index) => {
        b.x += b.vx; b.y += b.vy;
        if (state === "ARENA") {
            arenaObjects.enemies.forEach(e => {
                if (e.active && Math.hypot(b.x - e.x, b.y - e.y) < 20) {
                    e.hp--; b.hit = true;
                    if (e.hp <= 0) e.active = false;
                }
            });
        }
    });
    player.bullets = player.bullets.filter(b => !b.hit && b.x > 0 && b.x < 800 && b.y > 0 && b.y < 600);

    // Fiende AI
    if (state === "ARENA") {
        arenaObjects.enemies.forEach(e => {
            if (e.active) {
                let dist = Math.hypot(player.x - e.x, player.y - e.y);
                if (dist < 200) {
                    e.x += (player.x - e.x) * 0.02;
                    e.y += (player.y - e.y) * 0.02;
                }
                if (dist < 20) player.hp -= 0.5;
            }
        });
    }

    document.getElementById("hp").innerText = Math.ceil(player.hp);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (state === "ARENA") {
        // Tegn bakke
        ctx.fillStyle = "#2c3e50"; ctx.fillRect(0,0,800,600);
        // Vegger/Hus
        arenaObjects.walls.forEach(w => {
            ctx.fillStyle = w.color; ctx.fillRect(w.x, w.y, w.w, w.h);
            ctx.strokeStyle = "white"; ctx.strokeRect(w.x, w.y, w.w, w.h);
        });
        // Dører
        arenaObjects.doors.forEach(d => { ctx.fillStyle = "#5d3a1a"; ctx.fillRect(d.x, d.y, d.w, d.h); });
        // Våpen
        arenaObjects.guns.forEach(g => { if(g.active) { ctx.fillStyle = "#3498db"; ctx.fillRect(g.x-10, g.y-10, 20, 20); } });
        // Fiender
        arenaObjects.enemies.forEach(e => {
            if(e.active) {
                ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI*2); ctx.fill();
            }
        });
    } else {
        // SHOP
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0,0,800,600);
        shopObjects.walls.forEach(w => { ctx.fillStyle = "#333"; ctx.fillRect(w.x, w.y, w.w, w.h); });
        shopObjects.shelves.forEach(s => { ctx.fillStyle = "#27ae60"; ctx.fillRect(s.x, s.y, s.w, s.h); });
        shopObjects.doors.forEach(d => { ctx.fillStyle = "#5d3a1a"; ctx.fillRect(d.x, d.y, d.w, d.h); });
    }

    // Tegn spiller (Litt mer detaljert 2D-figur)
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);
    // Kropp
    ctx.fillStyle = player.color; ctx.fillRect(-15, -15, 30, 30);
    // Ansikt/Retning
    ctx.fillStyle = "black"; ctx.fillRect(5, -10, 5, 5); ctx.fillRect(5, 5, 5, 5);
    // Våpen hvis han har
    if (player.hasGun) {
        ctx.fillStyle = "gray"; ctx.fillRect(15, -5, 20, 10);
    }
    ctx.restore();

    // Tegn kuler
    ctx.fillStyle = "yellow";
    player.bullets.forEach(b => ctx.fillRect(b.x, b.y, 5, 5));
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
