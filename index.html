<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billig Bror: Shop & Arena</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        
        #hud {
            position: absolute; bottom: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.8); padding: 15px; border: 3px solid #3498db;
            border-radius: 10px; pointer-events: none;
        }

        #transition {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; color: white; display: none;
            align-items: center; justify-content: center; font-size: 40px; z-index: 1000;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.5); font-size: 24px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="transition">ENTERING...</div>
    <div id="crosshair">+</div>

    <div id="hud">
        <div style="color: #e74c3c;">HP: <span id="hp">100</span></div>
        <div id="location-text" style="color: #2ecc71;">LOCATION: ARENA</div>
        <div id="weapon-text" style="color: #aaa; font-size: 12px;">FINN VÅPEN (BLÅ BOKS)</div>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 640; canvas.height = 360;

// MAPS: 0=Luft, 1=Mur, 2=Speil, 3=Dør, 4=Hylle
const arenaMap = [
    1,1,1,1,1,1,1,1,1,1,
    1,0,0,0,0,0,0,0,0,1,
    1,0,2,2,3,2,2,0,0,1, // Dør (3) på bygningen
    1,0,0,0,0,0,0,0,0,1,
    1,0,0,0,0,0,0,0,0,1,
    1,0,0,1,1,1,0,0,0,1,
    1,0,0,1,0,0,0,0,0,1,
    1,0,0,3,0,0,0,0,0,1, // Enda en dør
    1,0,0,1,0,0,0,0,0,1,
    1,1,1,1,1,1,1,1,1,1
];

const shopMap = [
    1,1,1,3,1,1,
    1,0,0,0,0,1,
    1,0,0,0,0,1,
    1,4,4,0,0,1,
    1,0,0,0,0,1,
    1,1,1,1,1,1
];

let currentMap = arenaMap;
let mapSize = 10;
let locationName = "ARENA";

let player = {
    x: 5, y: 5, dirX: -1, dirY: 0, planeX: 0, planeY: 0.66,
    hp: 100, hasWeapon: false, is3rdPerson: false,
    pitch: 0, recoil: 0, flash: 0, inTransition: false
};

let sprites = [
    {x: 7, y: 3, type: 'gun', active: true, map: 'arena'},
    {x: 2, y: 2, type: 'enemy', active: true, hp: 3, map: 'arena'},
    {x: 1, y: 3, type: 'item', active: true, map: 'shop'}
];

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function startTransition(dest) {
    player.inTransition = true;
    const el = document.getElementById('transition');
    el.innerText = dest === 'shop' ? "ENTERING SHOP..." : "EXITING TO ARENA...";
    el.style.display = 'flex';
    
    setTimeout(() => {
        if (dest === 'shop') {
            currentMap = shopMap; mapSize = 6;
            player.x = 3; player.y = 1.5;
            locationName = "KIWI SHOP";
        } else {
            currentMap = arenaMap; mapSize = 10;
            player.x = 4; player.y = 3.5;
            locationName = "ARENA";
        }
        document.getElementById('location-text').innerText = "LOCATION: " + locationName;
        el.style.display = 'none';
        player.inTransition = false;
    }, 1000);
}

function update() {
    if (player.inTransition) return;

    const moveSpeed = 0.06;
    const rotSpeed = 0.04;

    if (keys['KeyW']) move(moveSpeed);
    if (keys['KeyS']) move(-moveSpeed);
    if (keys['KeyD']) rotate(-rotSpeed);
    if (keys['KeyA']) rotate(rotSpeed);
    if (keys['ArrowUp']) player.pitch = Math.min(player.pitch + 8, 150);
    if (keys['ArrowDown']) player.pitch = Math.max(player.pitch - 8, -150);
    if (keys['KeyB']) { player.is3rdPerson = !player.is3rdPerson; keys['KeyB'] = false; }

    // Interaksjon (T) - Sjekk for dør eller våpen
    if (keys['KeyT']) {
        // Sjekk dør
        let checkX = Math.floor(player.x + player.dirX * 0.5);
        let checkY = Math.floor(player.y + player.dirY * 0.5);
        if (currentMap[checkX + checkY * mapSize] === 3) {
            startTransition(locationName === "ARENA" ? 'shop' : 'arena');
            keys['KeyT'] = false;
        }
        
        // Sjekk våpen
        sprites.forEach(s => {
            if (s.type === 'gun' && s.active && Math.hypot(s.x-player.x, s.y-player.y) < 1) {
                s.active = false; player.hasWeapon = true;
                document.getElementById('weapon-text').innerText = "VÅPEN: PISTOL AKTIV";
            }
        });
    }

    if (keys['KeyI'] && player.hasWeapon && player.recoil === 0) {
        player.recoil = 15; player.flash = 5;
        // Enkel skyte-logikk mot fiender
        sprites.forEach(s => {
            if (s.type === 'enemy' && s.active && s.map === 'arena') {
                let dist = Math.hypot(s.x - player.x, s.y - player.y);
                if (dist < 10) { s.hp--; if (s.hp <= 0) s.active = false; }
            }
        });
    }

    if (player.recoil > 0) player.recoil -= 2;
    if (player.flash > 0) player.flash--;
}

function move(s) {
    let nextX = player.x + player.dirX * s;
    let nextY = player.y + player.dirY * s;
    if (currentMap[Math.floor(nextX) + Math.floor(player.y) * mapSize] === 0) player.x = nextX;
    if (currentMap[Math.floor(player.x) + Math.floor(nextY) * mapSize] === 0) player.y = nextY;
}

function rotate(s) {
    let oldX = player.dirX;
    player.dirX = player.dirX * Math.cos(s) - player.dirY * Math.sin(s);
    player.dirY = oldX * Math.sin(s) + player.dirY * Math.cos(s);
    let oldP = player.planeX;
    player.planeX = player.planeX * Math.cos(s) - player.planeY * Math.sin(s);
    player.planeY = oldP * Math.sin(s) + player.planeY * Math.cos(s);
}

function draw() {
    // Bakgrunn
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = "#222"; ctx.fillRect(0,canvas.height/2 + player.pitch, canvas.width, canvas.height);

    const zBuffer = [];

    // Raycasting Vegger
    for (let x = 0; x < canvas.width; x++) {
        let cameraX = 2 * x / canvas.width - 1;
        let rX = player.dirX + player.planeX * cameraX;
        let rY = player.dirY + player.planeY * cameraX;
        let mX = Math.floor(player.x), mY = Math.floor(player.y);
        let dX = Math.abs(1/rX), dY = Math.abs(1/rY);
        let sX, sY, sideX, sideY, hit=0, side;

        if (rX < 0) { sX = -1; sideX = (player.x - mX) * dX; } else { sX = 1; sideX = (mX + 1.0 - player.x) * dX; }
        if (rY < 0) { sY = -1; sideY = (player.y - mY) * dY; } else { sY = 1; sideY = (mY + 1.0 - player.y) * dY; }

        while(hit === 0) {
            if (sideX < sideY) { sideX += dX; mX += sX; side = 0; } else { sideY += dY; mY += sY; side = 1; }
            if (currentMap[mX + mY * mapSize] > 0) hit = 1;
        }

        let pDist = (side === 0) ? (sideX - dX) : (sideY - dY);
        zBuffer[x] = pDist;
        let h = Math.floor(canvas.height / pDist);
        let start = -h/2 + canvas.height/2 + player.pitch;

        // Veggfarger
        let type = currentMap[mX + mY * mapSize];
        if (type === 1) ctx.fillStyle = side === 1 ? "#444" : "#666";
        else if (type === 2) ctx.fillStyle = "#aaddff"; // Glass
        else if (type === 3) ctx.fillStyle = "#5d3a1a"; // Dør
        else if (type === 4) ctx.fillStyle = "#225522"; // Hylle
        
        // Shading basert på distanse
        let brightness = Math.max(0.2, 1 - pDist/8);
        ctx.globalAlpha = brightness;
        ctx.fillRect(x, start, 1, h);
        ctx.globalAlpha = 1;
    }

    // Sprites
    sprites.forEach(s => {
        if (!s.active || s.map !== (locationName === "ARENA" ? 'arena' : 'shop')) return;
        let sx = s.x - player.x, sy = s.y - player.y;
        let inv = 1.0 / (player.planeX * player.dirY - player.dirX * player.planeY);
        let tx = inv * (player.dirY * sx - player.dirX * sy);
        let ty = inv * (-player.planeY * sx + player.planeX * sy);
        if (ty > 0.1) {
            let sX = Math.floor((canvas.width/2) * (1 + tx/ty));
            let sH = Math.abs(Math.floor(canvas.height / ty));
            if (zBuffer[sX] > ty) {
                ctx.fillStyle = s.type === 'gun' ? "#3498db" : (s.type === 'enemy' ? "#e74c3c" : "#f1c40f");
                ctx.fillRect(sX - sH/4, canvas.height/2 - sH/4 + player.pitch, sH/2, sH/2);
            }
        }
    });

    if (player.hasWeapon && !player.is3rdPerson) drawGun();
    if (player.is3rdPerson) drawPlayer();
}



function drawGun() {
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height - 100 + player.pitch - player.recoil);
    ctx.fillStyle = "#222";
    ctx.fillRect(-20, 0, 40, 100); // Pistol kropp
    ctx.fillStyle = "#333";
    ctx.fillRect(-5, -40, 10, 50); // Løp
    if (player.flash > 0) {
        ctx.fillStyle = "orange";
        ctx.beginPath(); ctx.arc(0, -45, 15, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();
}

function drawPlayer() {
    let x = canvas.width/2, y = canvas.height/2 + 80 + player.pitch;
    ctx.fillStyle = "#ffdbac"; ctx.fillRect(x-10, y-100, 20, 20); // Hode
    ctx.fillStyle = "#2980b9"; ctx.fillRect(x-15, y-80, 30, 40); // Kropp
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
